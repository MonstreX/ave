class u{constructor(e={}){this.subscribers=new Map,this.computedCache=new Map,this.computedDeps=new Map,this.state=this.createReactive(e,[])}createReactive(e,t=[]){return this.isObject(e)?Array.isArray(e)?this.createReactiveArray(e,t):new Proxy(e,{get:(n,a)=>{this.trackDependency(t.concat(a));const s=n[a];return this.isObject(s)?this.createReactive(s,t.concat(a)):s},set:(n,a,s)=>(n[a]===s||(n[a]=s,this.notify(t.concat(a))),!0),deleteProperty:(n,a)=>(a in n&&(delete n[a],this.notify(t.concat(a))),!0)}):e}createReactiveArray(e,t){const n=this,a=["push","pop","shift","unshift","splice","sort","reverse"];return new Proxy(e,{get(l,i){if(n.trackDependency(t.concat(i)),a.includes(i))return function(...r){const c=Array.prototype[i].apply(l,r);return n.notify(t),c};const o=l[i];return n.isObject(o)?n.createReactive(o,t.concat(i)):o},set(l,i,o){return l[i]===o||(l[i]=o,n.notify(t.concat(i))),!0},deleteProperty(l,i){return i in l&&(delete l[i],n.notify(t)),!0}})}watch(e,t=null){typeof e=="function"&&(t=e,e=[]);const n=Array.isArray(e)?e:e.split("."),a=this.pathToKey(n);return this.subscribers.has(a)||this.subscribers.set(a,new Set),this.subscribers.get(a).add(t),()=>{const s=this.subscribers.get(a);s&&s.delete(t)}}notify(e){const t=this.pathToKey(e),n=this.subscribers.get(t);n&&n.forEach(s=>s(this.getByPath(e),e));for(let s=e.length-1;s>=0;s--){const l=e.slice(0,s),i=this.pathToKey(l),o=this.subscribers.get(i);o&&o.forEach(r=>r(this.getByPath(l),l))}const a=this.subscribers.get("");a&&a.forEach(s=>s(this.state,[]))}trackDependency(e){}getByPath(e){return e.reduce((t,n)=>t?.[n],this.state)}pathToKey(e){return Array.isArray(e)?e.join("."):e}isObject(e){return e!==null&&(typeof e=="object"||Array.isArray(e))}}window.Reactive=u;class h{constructor(e){this.config=e,this.translations=e.translations,console.log("DatabaseTableEditor init"),console.log("config.table:",e.table),console.log("config.oldTable:",e.oldTable),this.state=new u({table:e.oldTable||e.table,errors:{},isDirty:!1}),console.log("Reactive state initialized"),console.log("state.table:",this.state.state.table),console.log("state.table.columns:",this.state.state.table.columns),this.state.watch("table",()=>{this.state.state.isDirty=!0,this.validateTable(),this.render()}),window.dbConfig.table=this.state.state.table,this.init()}init(){this.render(),this.attachEventListeners(),this.validateTable()}attachEventListeners(){document.getElementById("btn-add-column")?.addEventListener("click",()=>{this.addColumn()}),document.getElementById("btn-add-timestamps")?.addEventListener("click",()=>{this.addTimestamps()}),document.getElementById("btn-add-softdeletes")?.addEventListener("click",()=>{this.addSoftDeletes()}),document.getElementById("database-form")?.addEventListener("submit",e=>{if(!this.validateTable())return e.preventDefault(),toastr.error("Please fix validation errors before saving"),!1;document.getElementById("table-data").value=JSON.stringify(this.state.state.table),window.dbConfig.table=this.state.state.table})}render(){const e=document.getElementById("columns-container");if(!e)return;const t=this.state.state.table.columns||[],n=document.getElementById("no-columns-message");if(t.length===0){n.style.display="block";return}n.style.display="none",e.innerHTML="",t.forEach((a,s)=>{const l=this.renderColumn(a,s);e.appendChild(l)})}renderColumn(e,t){const n=document.createElement("div");n.className="db-column-row",n.dataset.index=t;const a=this.state.state.errors[`columns.${t}`]||{};Object.keys(a).length>0&&n.classList.add("has-error");const s=document.createElement("div");s.className="db-column-header";const l=document.createElement("div");l.className="db-column-title",l.textContent=e.name||`Column ${t+1}`;const i=document.createElement("div");i.className="db-column-actions";const o=document.createElement("button");o.type="button",o.className="btn-remove-column",o.innerHTML='<i class="voyager-trash"></i>',o.title="Remove column",o.addEventListener("click",()=>this.removeColumn(t)),i.appendChild(o),s.appendChild(l),s.appendChild(i);const r=document.createElement("div");r.className="db-column-body",r.appendChild(this.createField("text","name",this.translations.field,e.name,t,{required:!0,pattern:this.config.identifierRegex})),r.appendChild(this.createTypeSelect(e,t));const c=this.getTypeInfo(e.type);if(c&&c.requiresLength&&r.appendChild(this.createField("text","length",this.translations.length,e.length,t,{placeholder:c.defaultLength||""})),r.appendChild(this.createField("text","default",this.translations.default,e.default,t)),r.appendChild(this.createCheckbox("notnull",this.translations.notNull,e.notnull,t)),c&&c.category==="numbers"&&r.appendChild(this.createCheckbox("unsigned",this.translations.unsigned,e.unsigned,t)),c&&(c.name==="integer"||c.name==="bigint"||c.name==="smallint")&&r.appendChild(this.createCheckbox("autoincrement",this.translations.autoIncrement,e.autoincrement,t)),r.appendChild(this.createIndexSelect(e,t)),e.composite){const d=document.createElement("div");d.className="db-column-warning",d.innerHTML=`<i class="voyager-warning"></i> ${this.translations.compositeWarning}`,r.appendChild(d)}if(Object.keys(a).length>0){const d=document.createElement("div");d.className="alert alert-danger",d.style.marginTop="10px",d.style.gridColumn="1 / -1",d.innerHTML=Object.values(a).join("<br>"),r.appendChild(d)}return n.appendChild(s),n.appendChild(r),n}createField(e,t,n,a,s,l={}){const i=document.createElement("div");i.className="db-field-group";const o=document.createElement("label");o.textContent=n,i.appendChild(o);const r=document.createElement("input");return r.type=e,r.value=a||"",r.className="form-control",Object.keys(l).forEach(c=>{r.setAttribute(c,l[c])}),r.addEventListener("input",c=>{this.updateColumn(s,t,c.target.value)}),i.appendChild(r),i}createCheckbox(e,t,n,a){const s=document.createElement("div");s.className="db-field-group checkbox";const l=document.createElement("input");l.type="checkbox",l.checked=!!n,l.id=`col-${a}-${e}`,l.addEventListener("change",o=>{this.updateColumn(a,e,o.target.checked)});const i=document.createElement("label");return i.htmlFor=l.id,i.textContent=t,s.appendChild(l),s.appendChild(i),s}createTypeSelect(e,t){const n=document.createElement("div");n.className="db-field-group";const a=document.createElement("label");a.textContent=this.translations.type,n.appendChild(a);const s=document.createElement("select");return s.className="form-control",Object.keys(this.config.types).forEach(l=>{const i=document.createElement("optgroup");i.label=l,this.config.types[l].forEach(o=>{const r=document.createElement("option");r.value=o.name,r.textContent=o.name,r.selected=e.type===o.name,o.supported||(r.disabled=!0,r.textContent+=` (${this.translations.typeNotSupported})`),i.appendChild(r)}),s.appendChild(i)}),s.addEventListener("change",l=>{this.updateColumn(t,"type",l.target.value)}),n.appendChild(s),n}createIndexSelect(e,t){const n=document.createElement("div");n.className="db-field-group";const a=document.createElement("label");a.textContent=this.translations.index,n.appendChild(a);const s=document.createElement("select");return s.className="form-control",[{value:"",label:this.translations.none},{value:"primary",label:this.translations.primary},{value:"unique",label:this.translations.unique},{value:"index",label:"INDEX"}].forEach(i=>{const o=document.createElement("option");o.value=i.value,o.textContent=i.label,o.selected=e.index===i.value,s.appendChild(o)}),s.addEventListener("change",i=>{this.updateColumn(t,"index",i.target.value)}),n.appendChild(s),n}getTypeInfo(e){for(const t in this.config.types){const n=this.config.types[t].find(a=>a.name===e);if(n)return{...n,category:t}}return null}updateColumn(e,t,n){const a=this.state.state.table.columns;if(!a[e]){console.error("Column not found:",e);return}a[e][t]=n,this.state.notify(["table","columns",e,t])}addColumn(){const e=this.state.state.table.columns||[],t={name:`column_${e.length+1}`,type:"string",length:null,default:null,notnull:!1,unsigned:!1,autoincrement:!1,index:null};e.push(t),this.state.notify(["table","columns"])}removeColumn(e){if(!confirm("Are you sure you want to remove this column?"))return;this.state.state.table.columns.splice(e,1),this.state.notify(["table","columns"])}addTimestamps(){const e=this.state.state.table.columns||[],t=e.some(a=>a.name==="created_at"),n=e.some(a=>a.name==="updated_at");if(t&&n){toastr.info("Timestamps already exist");return}t||e.push({name:"created_at",type:"datetime",length:null,default:null,notnull:!1,unsigned:!1,autoincrement:!1,index:null}),n||e.push({name:"updated_at",type:"datetime",length:null,default:null,notnull:!1,unsigned:!1,autoincrement:!1,index:null}),this.state.notify(["table","columns"]),toastr.success("Timestamps added")}addSoftDeletes(){const e=this.state.state.table.columns||[];if(e.some(n=>n.name==="deleted_at")){toastr.info("Soft deletes already exist");return}e.push({name:"deleted_at",type:"datetime",length:null,default:null,notnull:!1,unsigned:!1,autoincrement:!1,index:null}),this.state.notify(["table","columns"]),toastr.success("Soft deletes added")}validateTable(){const e={},t=this.state.state.table.columns||[],n={};t.forEach((s,l)=>{(!s.name||s.name.trim()==="")&&(e[`columns.${l}`]=e[`columns.${l}`]||{},e[`columns.${l}`].name=this.translations.nameWarning),n[s.name]&&(e[`columns.${l}`]=e[`columns.${l}`]||{},e[`columns.${l}`].duplicate=this.translations.columnAlreadyExists.replace(":column",s.name)),n[s.name]=!0});const a=t.filter(s=>s.index==="primary");return a.length>1&&a.forEach((s,l)=>{if(l>0){const i=t.indexOf(s);e[`columns.${i}`]=e[`columns.${i}`]||{},e[`columns.${i}`].primary=this.translations.tableHasIndex}}),this.state.state.errors=e,Object.keys(e).length===0}}document.addEventListener("DOMContentLoaded",()=>{window.dbConfig&&(window.dbEditor=new h(window.dbConfig))});
