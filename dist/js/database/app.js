class m{constructor(e){this.config=e,this.translations=e.translations,this.state=new Reactive({table:e.oldTable||e.table,errors:{},isDirty:!1}),this.state.watch("table",()=>{this.state.state.isDirty=!0,this.validateTable(),this.render()}),window.dbConfig.table=this.state.state.table,this.init()}init(){this.render(),this.attachEventListeners(),this.validateTable()}attachEventListeners(){document.getElementById("btn-add-column")?.addEventListener("click",()=>{this.addColumn()}),document.getElementById("btn-add-timestamps")?.addEventListener("click",()=>{this.addTimestamps()}),document.getElementById("btn-add-softdeletes")?.addEventListener("click",()=>{this.addSoftDeletes()}),document.getElementById("database-form")?.addEventListener("submit",e=>{if(!this.validateTable())return e.preventDefault(),toastr.error("Please fix validation errors before saving"),!1;document.getElementById("table-data").value=JSON.stringify(this.state.state.table),window.dbConfig.table=this.state.state.table})}render(){const e=document.getElementById("columns-container");if(!e)return;const t=this.state.state.table.columns||[],n=document.getElementById("no-columns-message");if(t.length===0){n.style.display="block";return}n.style.display="none",e.innerHTML="",t.forEach((l,a)=>{const s=this.renderColumn(l,a);e.appendChild(s)})}renderColumn(e,t){const n=document.createElement("div");n.className="db-column-row",n.dataset.index=t;const l=this.state.state.errors[`columns.${t}`]||{};Object.keys(l).length>0&&n.classList.add("has-error");const a=document.createElement("div");a.className="db-column-header";const s=document.createElement("div");s.className="db-column-title",s.textContent=e.name||`Column ${t+1}`;const o=document.createElement("div");o.className="db-column-actions";const d=document.createElement("button");d.type="button",d.className="btn-remove-column",d.innerHTML='<i class="voyager-trash"></i>',d.title="Remove column",d.addEventListener("click",()=>this.removeColumn(t)),o.appendChild(d),a.appendChild(s),a.appendChild(o);const i=document.createElement("div");i.className="db-column-body",i.appendChild(this.createField("text","name",this.translations.field,e.name,t,{required:!0,pattern:this.config.identifierRegex})),i.appendChild(this.createTypeSelect(e,t));const r=this.getTypeInfo(e.type);r&&r.requiresLength&&i.appendChild(this.createField("text","length",this.translations.length,e.length,t,{placeholder:r.defaultLength||""})),i.appendChild(this.createField("text","default",this.translations.default,e.default,t));const u=document.createElement("div");if(u.style.display="grid",u.style.gridColumn="1 / -1",u.style.gridTemplateColumns="repeat(auto-fit, minmax(150px, 1fr))",u.style.gap="10px",u.appendChild(this.createCheckbox("notnull",this.translations.notNull,e.notnull,t)),r&&r.category==="numbers"&&u.appendChild(this.createCheckbox("unsigned",this.translations.unsigned,e.unsigned,t)),r&&(r.name==="integer"||r.name==="bigint"||r.name==="smallint")&&u.appendChild(this.createCheckbox("autoincrement",this.translations.autoIncrement,e.autoincrement,t)),i.appendChild(u),i.appendChild(this.createIndexSelect(e,t)),e.composite){const c=document.createElement("div");c.className="db-column-warning",c.innerHTML=`<i class="voyager-warning"></i> ${this.translations.compositeWarning}`,i.appendChild(c)}if(Object.keys(l).length>0){const c=document.createElement("div");c.className="alert alert-danger",c.style.marginTop="10px",c.style.gridColumn="1 / -1",c.innerHTML=Object.values(l).join("<br>"),i.appendChild(c)}return n.appendChild(a),n.appendChild(i),n}createField(e,t,n,l,a,s={}){const o=document.createElement("div");o.className="db-field-group";const d=document.createElement("label");d.textContent=n,o.appendChild(d);const i=document.createElement("input");return i.type=e,i.value=l||"",i.className="form-control",Object.keys(s).forEach(r=>{i.setAttribute(r,s[r])}),i.addEventListener("input",r=>{this.updateColumn(a,t,r.target.value)}),o.appendChild(i),o}createCheckbox(e,t,n,l){const a=document.createElement("div");a.className="db-field-group checkbox";const s=document.createElement("input");s.type="checkbox",s.checked=!!n,s.id=`col-${l}-${e}`,s.addEventListener("change",d=>{this.updateColumn(l,e,d.target.checked)});const o=document.createElement("label");return o.htmlFor=s.id,o.textContent=t,a.appendChild(s),a.appendChild(o),a}createTypeSelect(e,t){const n=document.createElement("div");n.className="db-field-group";const l=document.createElement("label");l.textContent=this.translations.type,n.appendChild(l);const a=document.createElement("select");return a.className="form-control",Object.keys(this.config.types).forEach(s=>{const o=document.createElement("optgroup");o.label=s,this.config.types[s].forEach(d=>{const i=document.createElement("option");i.value=d.name,i.textContent=d.name,i.selected=e.type===d.name,d.supported||(i.disabled=!0,i.textContent+=` (${this.translations.typeNotSupported})`),o.appendChild(i)}),a.appendChild(o)}),a.addEventListener("change",s=>{this.updateColumn(t,"type",s.target.value)}),n.appendChild(a),n}createIndexSelect(e,t){const n=document.createElement("div");n.className="db-field-group";const l=document.createElement("label");l.textContent=this.translations.index,n.appendChild(l);const a=document.createElement("select");return a.className="form-control",[{value:"",label:this.translations.none},{value:"primary",label:this.translations.primary},{value:"unique",label:this.translations.unique},{value:"index",label:"INDEX"}].forEach(o=>{const d=document.createElement("option");d.value=o.value,d.textContent=o.label,d.selected=e.index===o.value,a.appendChild(d)}),a.addEventListener("change",o=>{this.updateColumn(t,"index",o.target.value)}),n.appendChild(a),n}getTypeInfo(e){for(const t in this.config.types){const n=this.config.types[t].find(l=>l.name===e);if(n)return{...n,category:t}}return null}updateColumn(e,t,n){const l=this.state.state.table.columns;if(!l[e]){console.error("Column not found:",e);return}l[e][t]=n,this.state.notify(["table","columns",e,t])}addColumn(){const e=this.state.state.table.columns||[],t={name:`column_${e.length+1}`,type:"string",length:null,default:null,notnull:!1,unsigned:!1,autoincrement:!1,index:null};e.push(t),this.state.notify(["table","columns"])}removeColumn(e){if(!confirm("Are you sure you want to remove this column?"))return;this.state.state.table.columns.splice(e,1),this.state.notify(["table","columns"])}addTimestamps(){const e=this.state.state.table.columns||[],t=e.some(l=>l.name==="created_at"),n=e.some(l=>l.name==="updated_at");if(t&&n){toastr.info("Timestamps already exist");return}t||e.push({name:"created_at",type:"datetime",length:null,default:null,notnull:!1,unsigned:!1,autoincrement:!1,index:null}),n||e.push({name:"updated_at",type:"datetime",length:null,default:null,notnull:!1,unsigned:!1,autoincrement:!1,index:null}),this.state.notify(["table","columns"]),toastr.success("Timestamps added")}addSoftDeletes(){const e=this.state.state.table.columns||[];if(e.some(n=>n.name==="deleted_at")){toastr.info("Soft deletes already exist");return}e.push({name:"deleted_at",type:"datetime",length:null,default:null,notnull:!1,unsigned:!1,autoincrement:!1,index:null}),this.state.notify(["table","columns"]),toastr.success("Soft deletes added")}validateTable(){const e={},t=this.state.state.table.columns||[],n={};t.forEach((a,s)=>{(!a.name||a.name.trim()==="")&&(e[`columns.${s}`]=e[`columns.${s}`]||{},e[`columns.${s}`].name=this.translations.nameWarning),n[a.name]&&(e[`columns.${s}`]=e[`columns.${s}`]||{},e[`columns.${s}`].duplicate=this.translations.columnAlreadyExists.replace(":column",a.name)),n[a.name]=!0});const l=t.filter(a=>a.index==="primary");return l.length>1&&l.forEach((a,s)=>{if(s>0){const o=t.indexOf(a);e[`columns.${o}`]=e[`columns.${o}`]||{},e[`columns.${o}`].primary=this.translations.tableHasIndex}}),this.state.state.errors=e,Object.keys(e).length===0}}document.addEventListener("DOMContentLoaded",()=>{window.dbConfig&&(window.dbEditor=new m(window.dbConfig))});
